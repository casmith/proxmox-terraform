---
- name: Create Ubuntu 24.04 Template with QEMU Guest Agent on Proxmox
  hosts: proxmox_cluster_primary
  gather_facts: no
  vars:
    template_id: 9000
    template_name: "ubuntu-2404-cloudinit-template"
    storage: "nfs-shared"  # Using NFS shared storage for cluster-wide access
    memory: 2048
    cores: 2
    bridge: "vmbr0"
    cloud_image_url: "https://cloud-images.ubuntu.com/noble/current/noble-server-cloudimg-amd64.img"

  tasks:
    - name: Enable snippets on local storage for cloud-init
      command: pvesm set local --content vztmpl,iso,backup,snippets
      changed_when: false

    - name: Check if template already exists
      command: qm status {{ template_id }}
      register: vm_exists
      failed_when: false
      changed_when: false

    - name: Skip if template already exists
      debug:
        msg: "Template {{ template_id }} already exists, skipping creation"
      when: vm_exists.rc == 0

    - name: Download Ubuntu 24.04 cloud image
      get_url:
        url: "{{ cloud_image_url }}"
        dest: /tmp/noble-server-cloudimg-amd64.img
        mode: '0644'
        timeout: 300
      when: vm_exists.rc != 0

    - name: Create base VM
      command: >
        qm create {{ template_id }}
        --name {{ template_name }}
        --memory {{ memory }}
        --cores {{ cores }}
        --net0 virtio,bridge={{ bridge }}
      register: create_result
      when: vm_exists.rc != 0

    - name: Import disk to storage
      command: >
        qm importdisk {{ template_id }}
        /tmp/noble-server-cloudimg-amd64.img
        {{ storage }}
      register: import_result
      when: vm_exists.rc != 0

    - name: Configure VM hardware - Attach imported disk
      command: >
        qm set {{ template_id }}
        --scsihw virtio-scsi-pci
        --scsi0 {{ storage }}:{{ template_id }}/vm-{{ template_id }}-disk-0.raw
      when: vm_exists.rc != 0

    - name: Configure VM hardware - Add cloud-init drive
      command: >
        qm set {{ template_id }}
        --ide2 {{ storage }}:cloudinit
      when: vm_exists.rc != 0

    - name: Configure VM hardware - Set boot disk
      command: >
        qm set {{ template_id }}
        --boot c
        --bootdisk scsi0
      when: vm_exists.rc != 0

    - name: Configure VM hardware - Add serial console
      command: >
        qm set {{ template_id }}
        --serial0 socket
        --vga serial0
      when: vm_exists.rc != 0

    - name: Configure VM hardware - Enable QEMU agent
      command: >
        qm set {{ template_id }}
        --agent enabled=1
      when: vm_exists.rc != 0

    - name: Configure VM hardware - Set CPU type
      command: >
        qm set {{ template_id }}
        --cpu host
      when: vm_exists.rc != 0

    - name: Convert VM to template
      command: qm template {{ template_id }}
      when: vm_exists.rc != 0

    - name: Clean up downloaded image
      file:
        path: /tmp/noble-server-cloudimg-amd64.img
        state: absent
      when: vm_exists.rc != 0

    - name: Wait for cluster configuration sync
      pause:
        seconds: 5
        prompt: "Waiting for cluster configuration to sync across all nodes..."

    - name: Display success message
      debug:
        msg:
          - "============================================"
          - "Template {{ template_id }} created successfully!"
          - "============================================"
          - ""
          - "Template includes:"
          - "  ✓ Ubuntu 24.04 LTS"
          - "  ✓ Cloud-init enabled"
          - "  ✓ Serial console"
          - "  ✓ Snippets storage configured"
          - "  ✓ Stored on NFS shared storage"
          - ""
          - "Ready to use with Terraform!"
          - "Terraform will auto-install QEMU guest agent via cloud-init"

- name: Verify Template Availability on All Cluster Nodes
  hosts: proxmox_cluster
  gather_facts: no
  vars:
    template_id: 9000

  tasks:
    - name: Check if template is visible on this node
      command: qm status {{ template_id }}
      register: template_status
      changed_when: false
      failed_when: false

    - name: Check NFS storage accessibility
      shell: pvesm status | grep nfs-shared
      register: storage_check
      changed_when: false
      failed_when: false

    - name: Display template and storage status
      debug:
        msg:
          - "Node: {{ inventory_hostname }}"
          - "Template {{ template_id }}: {{ 'VISIBLE' if template_status.rc == 0 else 'NOT VISIBLE' }}"
          - "NFS storage: {{ 'ACCESSIBLE' if storage_check.rc == 0 else 'NOT ACCESSIBLE' }}"

    - name: Warn if template not visible
      debug:
        msg:
          - "WARNING: Template {{ template_id }} is not visible on {{ inventory_hostname }}"
          - "This may indicate:"
          - "  - Cluster configuration sync delay (wait 10-30 seconds)"
          - "  - NFS storage not mounted on this node"
          - "  - Permissions issue with shared storage"
      when: template_status.rc != 0
